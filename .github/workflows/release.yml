name: Build & Release

on:
    push:
        tags:
            - "v*" # ä»…åœ¨æ¨ tag æ—¶è§¦å‘ï¼Œæ¯”å¦‚ v1.7.2

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    # ä½¿ç”¨ Ubuntu runner è¿è¡Œ fyne-crossï¼Œå› ä¸ºå®ƒæœ‰ Docker æ”¯æŒ
                    - os: ubuntu-latest
                      platform: darwin
                      arch: amd64,arm64
                      artifact_name: apple-store-helper-darwin
                    - os: ubuntu-latest
                      platform: windows
                      arch: 386,amd64
                      artifact_name: apple-store-helper-windows

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: "1.22"

            - name: Install system dependencies
              run: |
                  # å®‰è£…éŸ³é¢‘å¼€å‘åº“ï¼ˆbeep éœ€è¦ï¼‰å’Œ Docker
                  sudo apt-get update
                  sudo apt-get install -y portaudio19-dev pkg-config

                  # æ£€æŸ¥ Docker æ˜¯å¦å¯ç”¨
                  docker --version

            - name: Install Fyne tools
              run: |
                  go install fyne.io/fyne/v2/cmd/fyne@latest
                  go install github.com/fyne-io/fyne-cross@latest
                  echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

            - name: Cache fyne-cross engines
              uses: actions/cache@v4
              with:
                  path: ~/.fyne-cross
                  key: ubuntu-fyne-cross-${{ matrix.platform }}-${{ hashFiles('go.mod') }}

            - name: Get tag version
              id: vars
              run: echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

            - name: Build with fyne-cross
              run: |
                  export PATH="$(go env GOPATH)/bin:$PATH"

                  # ä½¿ç”¨ fyne-cross æ„å»º
                  fyne-cross ${{ matrix.platform }} \
                    -arch=${{ matrix.arch }} \
                    -app-id=apple.store.helper \
                    -name="Apple Store Helper" \
                    -ldflags="-X 'github.com/hteen/apple-store-helper/common.VERSION=${{ steps.vars.outputs.tag }}'"

                  # æ£€æŸ¥æ„å»ºç»“æœ
                  if [ ! -d "fyne-cross/dist" ]; then
                      echo "âŒ fyne-cross æ„å»ºå¤±è´¥ï¼šdist ç›®å½•æœªç”Ÿæˆ"
                      exit 1
                  fi
                  echo "âœ… fyne-cross æ„å»ºæˆåŠŸ"

            - name: Prepare Darwin packages
              if: matrix.platform == 'darwin'
              run: |
                  # åœ¨ Ubuntu ä¸Šæ„å»ºçš„ Darwin åŒ…éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç­¾å
                  echo "â„¹ï¸ Darwin åŒ…å·²æ„å»ºå®Œæˆï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç­¾å"
                  echo "ğŸ“¦ æ„å»ºçš„åŒ…ä½ç½®ï¼š"
                  find fyne-cross/dist -name "*.app" -type d

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact_name }}-${{ steps.vars.outputs.tag }}
                  path: fyne-cross/dist/
                  if-no-files-found: error
                  retention-days: 30

    release:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Release
              uses: ncipollo/release-action@v1
              with:
                  tag: ${{ github.ref_name }}
                  name: Release ${{ github.ref_name }}
                  body: |
                      ## What's New
                      - Auto build for ${{ github.ref_name }}
                      - Cross-platform build with fyne-cross
                      - Supports: darwin-amd64, darwin-arm64, windows-386, windows-amd64

                      ## æ³¨æ„äº‹é¡¹
                      - Darwin åŒ…éœ€è¦æ‰‹åŠ¨ç­¾åæ‰èƒ½åœ¨ macOS ä¸Šè¿è¡Œ
                      - ç­¾åå‘½ä»¤ï¼š`xattr -cr "Apple Store Helper.app" && codesign --force --deep --sign - "Apple Store Helper.app"`
                  artifacts: "artifacts/*"
